<!DOCTYPE html>
<html lang="th">
<head>
<meta charset="UTF-8" />
<title>Lucky Warp Screen</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0" />

<style>
  * { box-sizing: border-box; font-family: system-ui, -apple-system, sans-serif; }

  body {
    margin: 0;
    background: radial-gradient(circle at top left, #2e335a 0%, #171b2e 50%, #0c0f1a 100%);
    min-height: 100vh;
    padding: 24px;
    color: #fff;
    display: flex;
    justify-content: center;
    align-items: center;
  }

  .wrap {
    width: 96%;
    max-width: 1700px;
    height: 85vh;
    background: rgba(10, 12, 24, 0.92);
    border-radius: 36px;
    padding: 40px;
    display: flex;
    gap: 40px;
    box-shadow: 0 24px 60px rgba(0,0,0,0.7);
  }

  /* รูปลูกค้า */
  .image-panel {
    flex: 0 0 45%;
    display: flex;
    justify-content: center;
    align-items: center;
  }

  .image-frame {
    width: 100%;
    max-width: 650px;
    aspect-ratio: 4 / 5;   /* Portrait */
    border-radius: 32px;
    overflow: hidden;
    background: #000;
    border: 6px solid rgba(255,255,255,0.12);
    box-shadow: 0 20px 40px rgba(0,0,0,0.8);
  }

  .image-frame img {
    width: 100%;
    height: 100%;
    object-fit: contain;
  }

  /* ฝั่งข้อความ */
  .text-panel {
    flex: 1;
    display: flex;
    flex-direction: column;
    justify-content: flex-start;
    padding-top: 20px;
    position: relative;
  }

  .ig-header {
    display: flex;
    align-items: center;
    gap: 16px;
    margin-bottom: 12px;
  }

  .ig-logo {
    width: 68px;
    height: 68px;
    border-radius: 16px;
    background: radial-gradient(circle at 30% 30%, #fff 0%, #ff0069 30%, #ff8a00 70%, #ffd600 100%);
    display: flex;
    justify-content: center;
    align-items: center;
    box-shadow: 0 0 22px rgba(255, 0, 120, 0.7);
  }

  .ig-logo-icon {
    width: 36px;
    height: 36px;
    background: url("https://upload.wikimedia.org/wikipedia/commons/a/a5/Instagram_icon.png") center/cover no-repeat;
  }

  /* ⭐ IG name ใหญ่ขึ้น */
  .ig-name {
    font-size: 4rem;
    font-weight: 800;
    letter-spacing: 0.03em;
  }

  /* ⭐ ข้อความใหญ่ขึ้น */
  .message {
    font-size: 2.6rem;
    font-weight: 700;
    color: #ffe66b;
    line-height: 1.4;
    margin-top: 12px;
    text-shadow: 0 2px 8px rgba(0,0,0,0.9);
  }

  /* ⭐ QR ใหญ่ขึ้นมุมล่างขวา */
  .promo-panel {
    position: absolute;
    bottom: 0;
    right: 0;
    display: flex;
    align-items: center;
    gap: 22px;
    padding: 10px;
  }

  .qr-img {
    width: 150px;
    height: 150px;
    border-radius: 20px;
    background: #fff;
    padding: 10px;
    box-shadow: 0 0 22px rgba(0,0,0,0.7);
  }

  .qr-text {
    font-size: 1.8rem;
    line-height: 1.4;
  }

  .qr-text span {
    font-size: 2.2rem;
    font-weight: 800;
    color: #ffb347;
    text-shadow: 0 0 12px rgba(255,179,71,0.9);
  }

  .tag-lucky {
    padding: 12px 26px;
    border-radius: 999px;
    font-size: 1.35rem;
    background: linear-gradient(135deg, #ff4b8b, #ffb347);
    color: #111;
    font-weight: 800;
    box-shadow: 0 0 20px rgba(255,99,132,0.6);
  }

  /* Animation */
  .fade-in {
    animation: fadeIn 0.6s ease-out;
  }

  @keyframes fadeIn {
    from { opacity: 0; transform: translateY(12px); }
    to   { opacity: 1; transform: translateY(0);    }
  }
</style>
</head>

<body>
  <div class="wrap">
    <div class="image-panel">
      <div class="image-frame">
        <img id="warp-image" src="">
      </div>
    </div>

    <div class="text-panel">
      <div class="ig-header">
        <div class="ig-logo"><div class="ig-logo-icon"></div></div>
        <div class="ig-name" id="warp-ig">@someone</div>
      </div>

      <div class="message" id="warp-message">ข้อความจากลูกค้า...</div>

      <div class="promo-panel">
        <img class="qr-img" src="https://hihydraa.github.io/Warp_BaanHome/qrcode_form.png">

        <div class="qr-text">แจกวาร์ปขึ้นจอ<br>
          <span>SCAN เลย</span>
        </div>

        <div class="tag-lucky">Lucky Warp</div>
      </div>
    </div>
  </div>



<script>
  // ======= CONFIG =======
  const API_URL = 'https://script.google.com/macros/s/AKfycbyPe0m5QIrapr1sThYjwTHRASCXhrOf9qTMcRwKrNyPfCCdYvOjT7xS5drG7840O6-ztg/exec';
  const DISPLAY_INTERVAL_MS = 30000;  // แต่ละภาพอยู่บนจอ 30 วิ
  const REFRESH_INTERVAL_MS = 5000;   // ดึงข้อมูลจาก Google Sheet ทุก 5 วิ

  let items = [];            // ข้อมูลทั้งหมดที่ approved
  let shownKeys = new Set(); // เก็บรายการที่แสดงไปแล้วใน “รอบนี้”
  let currentDisplayKey = null; // ใช้กันรูป/ข้อความไม่ตรงกัน

  const imgEl = document.getElementById('warp-image');
  const igEl  = document.getElementById('warp-ig');
  const msgEl = document.getElementById('warp-message');

  function makeKey(item) {
    return (item.timestamp || '') + '|' + (item.ig || '') + '|' + (item.imageUrl || '');
  }

  function showEmpty() {
    imgEl.src = '';
    igEl.textContent  = '';
    msgEl.textContent = 'ยังไม่มีวาร์ปในตอนนี้';
  }

  // ดึงข้อมูลจาก Apps Script → Google Sheet
  async function fetchData() {
    try {
      const res = await fetch(API_URL + '?t=' + Date.now());
      if (!res.ok) throw new Error('Fetch error');

      let data = await res.json();
      let rows = Array.isArray(data) ? data : [];

      rows = rows.filter(r => (r.status || 'approved') === 'approved');

      rows.sort((a, b) => {
        const ta = a.timestamp ? new Date(a.timestamp).getTime() : 0;
        const tb = b.timestamp ? new Date(b.timestamp).getTime() : 0;
        return ta - tb;
      });

      items = rows;

    } catch (err) {
      console.error('fetchData error:', err);
    }
  }

  // เลือกรายการถัดไป (ลูกค้าใหม่ลัดคิวก่อน)
  function pickNextItem() {
    if (!items || items.length === 0) return null;

    const notShown = [];
    const alreadyShown = [];

    for (const it of items) {
      const key = makeKey(it);
      if (!shownKeys.has(key)) notShown.push(it);
      else alreadyShown.push(it);
    }

    let candidateList;
    if (notShown.length > 0) {
      candidateList = notShown;
    } else {
      shownKeys.clear();
      candidateList = items;
    }

    const idx = Math.floor(Math.random() * candidateList.length);
    const nextItem = candidateList[idx];
    shownKeys.add(makeKey(nextItem));
    return nextItem;
  }

  // ⭐ โหลดรูปให้เสร็จก่อน แล้วค่อยอัปเดตทั้งรูป + ข้อความพร้อมกัน
  function renderItem(item, keyExpected) {
    if (!item) {
      showEmpty();
      return;
    }

    const ig  = item.ig || '';
    const msg = item.message || '';
    const img = item.imageUrl || '';

    // สร้าง Image object ใหม่ไว้ preload
    const tempImg = new Image();

    tempImg.onload = () => {
      // ถ้าระหว่างโหลด มีรอบใหม่เลือก item อื่นแล้ว → ไม่ต้องอัปเดต (กันรูปหลุดคิว)
      if (keyExpected !== currentDisplayKey) return;

      imgEl.src = img;
      igEl.textContent  = ig;
      msgEl.textContent = msg;

      [imgEl, igEl, msgEl].forEach(el => {
        el.classList.remove('fade-in');
        void el.offsetWidth;
        el.classList.add('fade-in');
      });
    };

    tempImg.onerror = () => {
      if (keyExpected !== currentDisplayKey) return;
      // โหลดรูปไม่สำเร็จ → แสดงเฉพาะข้อความ
      imgEl.src = '';
      igEl.textContent  = ig;
      msgEl.textContent = msg;
    };

    // เริ่มโหลดรูป (browser จะโหลด แต่ยังไม่เปลี่ยน imgEl จนกว่า onload)
    tempImg.src = img;
  }

  // loop แสดงผล
  async function renderLoop() {
    const nextItem = pickNextItem();
    const key = nextItem ? makeKey(nextItem) : null;
    currentDisplayKey = key;         // จำว่าตอนนี้เรากำลังจะโชว์รายการไหน
    renderItem(nextItem, key);
    setTimeout(renderLoop, DISPLAY_INTERVAL_MS);
  }

  // ======= เริ่มทำงาน =======
  async function init() {
    await fetchData();
    if (!items.length) showEmpty();
    renderLoop();
    setInterval(fetchData, REFRESH_INTERVAL_MS);
  }

  init();
</script>

 


  

</body>
</html>
